platform: Linux

default: &default
  path: examples
  binary: ex

  # Compilation configuration.
  build: &default-build
    c: ["mips-linux-gnu-gcc"]
    cpp: ["mips-linux-gnu-g++"]
    optimizations: ["-O0", "-O1", "-O2", "-O3", "-Os"]
    flags: []

  # Reassembly configuration.
  reassemble:
    compiler: "mips-linux-gnu-gcc"

  # Test configuration.
  test:
    wrapper: "qemu-mips -L /usr/mips-linux-gnu"
    strip_exe: "mips-linux-gnu-strip"
    sstrip: false
    strip: false
    skip: false
    cfg_checks:
      - dangling_auxdata

assembly: &assembly
  <<: *default
  path: examples/mips_asm_examples
  build: &assembly-build
    <<: *default-build
    optimizations: [""]

test-strip-default: &test-strip-default
  test:
    wrapper: "qemu-mips -L /usr/mips-linux-gnu"
    strip_exe: "mips-linux-gnu-strip"
    sstrip: false
    strip: true
    skip: false

test-sstrip-default: &test-sstrip-default
  test:
    wrapper: "qemu-mips -L /usr/mips-linux-gnu"
    strip_exe: "mips-linux-gnu-strip"
    sstrip: true
    strip: false
    skip: false

# FIXME: Remove when examples work for all optimization levels.
zero-optimize: &zero-optimize
  <<: *default
  build:
    c: ["mips-linux-gnu-gcc"]
    cpp: ["mips-linux-gnu-g++"]
    optimizations: ["-O0"]
    flags: []

tests:

  - name: ex1
    <<: *default

  - name: ex_2modulesPIC
    <<: *default

  - name: ex_adder
    <<: *default

  - name: ex_confusing_data
    <<: *default

  - name: ex_copy_relo
    <<: *default

  - name: ex_data_limit
    <<: *default
    binary: ex
    reassemble:
      compiler: "mips-linux-gnu-gcc"
      # 0x500000 is to make the addresses of .text and .data changed from the
      # original.
      flags: ["fun.so", "-Wl,-Ttext=0x500000"]

  - name: ex_dyn_library
    <<: *default
    binary: fun.so

  # Capstone v5 does not support:
  #   cd4:       460c0137        c.ule.s $fcc1,$f0,$f12
  #   This affects tests other than -O0.
  #   TODO: Enable other optimization levels with capstone v6.
  - name: ex_dyn_library2
    <<: *zero-optimize
    binary: fun.so

  - name: ex_emit_relocs
    <<: *default

  - name: ex_false_pointer_array
    <<: *default

  - name: ex_float
    <<: *default

  - name: ex_fprintf
    <<: *default

  - name: ex_getoptlong
    <<: *default

  - name: ex_imported_tls_syms
    <<: *default
    reassemble:
      compiler: "mips-linux-gnu-g++"

  - name: ex_init_array
    <<: *default

  - name: ex_memberPointer
    <<: *default

  - name: ex_noreturn
    <<: *default

  - name: ex_pointerReattribution
    <<: *default

  - name: ex_pointerReattribution2
    <<: *default

  - name: ex_pointerReattribution3
    <<: *default

  - name: ex_stat
    <<: *default

  - name: ex_struct
    <<: *default

  - name: ex_switch
    <<: *default

  - name: ex_symbol_selection
    <<: *default
    binary: fun.so

  - name: ex_synchronous_access
    <<: *default

  - name: ex_thread_local
    <<: *default

  - name: ex_tls_global_dynamic
    <<: *default
    binary: libtls.so

  - name: ex_tls_initial_exec
    <<: *default
    binary: libtls.so

  - name: ex_tls_local_dynamic
    <<: *default
    binary: libtls.so

  - name: ex_tls_local_exec
    <<: *default

  - name: ex_uninitialized_data
    <<: *default

  - name: ex_virtualDispatch
    <<: *default

  # FIXME: ex_exceptions{1,2,3}: .gcc_except_table

  # ---------------------------------------------------------------------------
  # stripped binaries
  # ---------------------------------------------------------------------------
  - name: ex1
    <<: *default
    <<: *test-strip-default

  - name: ex_2modulesPIC
    <<: *default
    <<: *test-strip-default

  - name: ex_adder
    <<: *default
    <<: *test-strip-default

  - name: ex_confusing_data
    <<: *default
    <<: *test-strip-default

  - name: ex_copy_relo
    <<: *default
    <<: *test-strip-default

  - name: ex_data_limit
    <<: *default
    <<: *test-strip-default
    binary: ex
    reassemble:
      compiler: "mips-linux-gnu-gcc"
      # 0x500000 is to make the addresses of .text and .data changed from the
      # original.
      flags: ["fun.so", "-Wl,-Ttext=0x500000"]

  - name: ex_dyn_library
    <<: *default
    <<: *test-strip-default
    binary: fun.so

  # Capstone v5 does not support:
  #   cd4:       460c0137        c.ule.s $fcc1,$f0,$f12
  #   This affects tests other than -O0.
  #   TODO: Enable other optimization levels with capstone v6.
  - name: ex_dyn_library2
    <<: *zero-optimize
    <<: *test-strip-default
    binary: fun.so

  - name: ex_emit_relocs
    <<: *default
    <<: *test-strip-default

  - name: ex_false_pointer_array
    <<: *default
    <<: *test-strip-default

  - name: ex_float
    <<: *default
    <<: *test-strip-default

  - name: ex_fprintf
    <<: *default
    <<: *test-strip-default

  - name: ex_getoptlong
    <<: *default
    <<: *test-strip-default

  - name: ex_imported_tls_syms
    <<: *default
    <<: *test-strip-default
    reassemble:
      compiler: "mips-linux-gnu-g++"

  - name: ex_init_array
    <<: *default
    <<: *test-strip-default

  - name: ex_memberPointer
    <<: *default
    <<: *test-strip-default

  - name: ex_noreturn
    <<: *default
    <<: *test-strip-default

  - name: ex_pointerReattribution
    <<: *default
    <<: *test-strip-default

  - name: ex_pointerReattribution2
    <<: *default
    <<: *test-strip-default

  - name: ex_pointerReattribution3
    <<: *default
    <<: *test-strip-default

  - name: ex_stat
    <<: *default
    <<: *test-strip-default

  - name: ex_struct
    <<: *default
    <<: *test-strip-default

  - name: ex_switch
    <<: *default
    <<: *test-strip-default

  - name: ex_symbol_selection
    <<: *default
    <<: *test-strip-default
    binary: fun.so

  - name: ex_synchronous_access
    <<: *default
    <<: *test-strip-default

  - name: ex_thread_local
    <<: *default
    <<: *test-strip-default

  - name: ex_tls_global_dynamic
    <<: *default
    <<: *test-strip-default
    binary: libtls.so

  - name: ex_tls_initial_exec
    <<: *default
    <<: *test-strip-default
    binary: libtls.so

  - name: ex_tls_local_dynamic
    <<: *default
    <<: *test-strip-default
    binary: libtls.so

  - name: ex_tls_local_exec
    <<: *default
    <<: *test-strip-default

  - name: ex_uninitialized_data
    <<: *default
    <<: *test-strip-default

  - name: ex_virtualDispatch
    <<: *default
    <<: *test-strip-default

  # ---------------------------------------------------------------------------
  # sectionless (sstripped)
  # ---------------------------------------------------------------------------
  - name: ex1
    <<: *default
    <<: *test-sstrip-default

  - name: ex_2modulesPIC
    <<: *default
    <<: *test-sstrip-default

  - name: ex_adder
    <<: *default
    <<: *test-sstrip-default

  - name: ex_confusing_data
    <<: *default
    <<: *test-sstrip-default

  - name: ex_copy_relo
    <<: *default
    <<: *test-sstrip-default

  - name: ex_data_limit
    <<: *default
    <<: *test-sstrip-default
    binary: ex
    reassemble:
      compiler: "mips-linux-gnu-gcc"
      # 0x500000 is to make the addresses of .text and .data changed from the
      # original.
      flags: ["fun.so", "-Wl,-Ttext=0x500000"]

  # Failed with -Os
  #- name: ex_dyn_library
  #  <<: *default
  #  <<: *test-sstrip-default
  #  binary: fun.so

  # Problem1:
  #   Capstone v5 does not support:
  #     cd4:       460c0137        c.ule.s $fcc1,$f0,$f12
  #     This affects tests other than -O0.
  # Problem2:
  #     ERROR: version node not found for symbol sqrtl@GLIBC_2.0
  #- name: ex_dyn_library2
  #  <<: *default
  #  <<: *test-sstrip-default
  #  binary: fun.so

  - name: ex_emit_relocs
    <<: *default
    <<: *test-sstrip-default

  - name: ex_false_pointer_array
    <<: *default
    <<: *test-sstrip-default

  - name: ex_float
    <<: *default
    <<: *test-sstrip-default

  - name: ex_fprintf
    <<: *default
    <<: *test-sstrip-default

  - name: ex_getoptlong
    <<: *default
    <<: *test-sstrip-default

  #- name: ex_imported_tls_syms
  #  <<: *default
  #  <<: *test-sstrip-default
  #  reassemble:
  #    compiler: "mips-linux-gnu-g++"

  #- name: ex_init_array
  #  <<: *default
  #  <<: *test-sstrip-default

  - name: ex_memberPointer
    <<: *default
    <<: *test-sstrip-default

  - name: ex_noreturn
    <<: *default
    <<: *test-sstrip-default

  - name: ex_pointerReattribution
    <<: *default
    <<: *test-sstrip-default

  - name: ex_pointerReattribution2
    <<: *default
    <<: *test-sstrip-default

  - name: ex_pointerReattribution3
    <<: *default
    <<: *test-sstrip-default

  - name: ex_stat
    <<: *default
    <<: *test-sstrip-default

  - name: ex_struct
    <<: *default
    <<: *test-sstrip-default

  - name: ex_switch
    <<: *default
    <<: *test-sstrip-default

  # Problem2:
  #   ERROR: version node not found for symbol printf@GLIBC_2.0
  #- name: ex_symbol_selection
  #  <<: *default
  #  <<: *test-sstrip-default
  #  binary: fun.so

  - name: ex_synchronous_access
    <<: *default
    <<: *test-sstrip-default

  #- name: ex_thread_local
  #  <<: *default
  #  <<: *test-sstrip-default

  #- name: ex_tls_global_dynamic
  #  <<: *default
  #  <<: *test-sstrip-default
  #  binary: libtls.so

  #- name: ex_tls_local_dynamic
  #  <<: *default
  #  <<: *test-sstrip-default
  #  binary: libtls.so

  #- name: ex_tls_initial_exec
  #  <<: *default
  #  <<: *test-sstrip-default
  #  binary: libtls.so

  #- name: ex_tls_local_exec
  #  <<: *default
  #  <<: *test-sstrip-default

  - name: ex_uninitialized_data
    <<: *default
    <<: *test-sstrip-default

  - name: ex_virtualDispatch
    <<: *default
    <<: *test-sstrip-default

  # ----------------------------------------------------------------------------
  # Assembly examples.
  # ----------------------------------------------------------------------------

  - name: ex_got_ofst
    <<: *assembly

  - name: ex_nop_block
    <<: *assembly

  - name: ex_pointerReattribution3
    <<: *assembly

  - name: ex_symbol_selection
    <<: *assembly
    binary: fun.so
